name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /opt/manoe
            git fetch origin
            git checkout main
            git pull origin main
            
            echo "=== Deploying API Gateway ==="
            
            # Build new image first
            docker compose -f docker-compose.vps.yml build api-gateway
            
            # Remove orphan container if exists (created outside compose)
            if docker ps -a --format '{{.Names}}' | grep -q '^manoe-api-gateway$'; then
              echo "Removing existing container..."
              docker stop manoe-api-gateway 2>/dev/null || true
              docker rm -f manoe-api-gateway 2>/dev/null || true
            fi
            
            # Start new container
            docker compose -f docker-compose.vps.yml up -d api-gateway
            
            echo "Waiting for API Gateway to be healthy..."
            for i in {1..12}; do
              if docker exec manoe-api-gateway curl -f http://localhost:3000/api/health 2>/dev/null; then
                echo "API Gateway health check passed!"
                echo "=== Deployment completed successfully! ==="
                exit 0
              fi
              echo "Attempt $i/12 failed, retrying in 5s..."
              sleep 5
            done
            
            echo "ERROR: API Gateway health check failed after 60s!"
            docker logs manoe-api-gateway --tail 50
            exit 1
